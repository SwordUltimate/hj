<!doctype html>
<script src="code/json.js"></script>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<style type="text/css">
* {
	margin: 0;
	padding: 0;
}

html, body {
	height: 100%;
	width: 100%;
}

canvas {
	display: block;
}

.table_div {
	position: fixed;
	top: 50%;
	left: 50%;
	width: 500px;
	height: 300px;
	background-color: green;
	-webkit-transform: translateX(-50%) translateY(-50%);
	text-align: center;
	position: absolute;
	margin: auto;
	z-index: 101;
}

label {
	padding-left: 10px;
	font-size: 14px;
	font-weight: bold;
	color: red;
	font-size: 14px;
}

.mark {
	position: absolute;
	left: 0px;
	top: 0px;
	width: 100%;
	height: 100%;
	background-color: gray;
	z-index: 100;
	opacity: 0.8;
	display: none;
}

.loginPanel {
	position: absolute;
	width: 500px;
	height: 300px;
	left: 50%;
	top: 50%;
	margin-left: -250px;
	margin-top: -150px;
	display: none;
	z-index: 101;
	margin-left: -250px;
	background-color: #F5FBFF;
	text-align: center;
}

.registerPanel {
	position: absolute;
	width: 500px;
	height: 300px;
	left: 50%;
	top: 50%;
	margin-left: -250px;
	margin-top: -150px;
	display: none;
	z-index: 102;
	margin-left: -250px;
	background-color: #F5FBFF;
	text-align: center;
}

.t_table {
	width: 100%;
	height: 100%;
	color: black;
}

.t_table .title {
	text-align: right;
}

.t_table .txt {
	text-align: left;
}

.t_table td {
	padding-left: 20px;
}
</style>

<script type="text/javascript">
	// 用户名，密码
	function RunGameUser(name, pwd) {
		this.name = name;
		this.pwd = pwd;
	}
	// 用户名，登录时间
	function LoginUser(name, loginTime) {
		this.name = name;
		this.loginTime = loginTime;
	}

	var loginUser;

	window.onload = function() {
		if (!checkLogin()) {
			// 显示遮罩层
			showPanel("mark");
			// 弹出登录页面
			showPanel("loginPanel");
			// focus
			document.getElementById("name").focus();
		}
	}

	function checkLogin() {
		// 判断session中是否有已登录用户
		var userStr = localStorage.getItem("runGameLoginUser");
		if (userStr == null)
			return false;
		// 判断session是否过期
		loginUser = JSON.parse(userStr);
		// 获取登录时间
		var ts = loginUser.loginTime;
		// 当前时间
		var n = Date.parse(new Date());
		var diff = (n - ts) / 1000 / 60;
		// 超期则移除
		if (diff > 30) {
			localStorage.removeItem("runGameLoginUser");
			// 将loginUser置空
			loginUser = null;
			return false;
		}
		if (loginUser == null) {
			return false;
		}
		// 显示登录用户
		document.getElementById("userName").innerHTML = loginUser.name;
		return true;
	}

	// 显示层
	function showPanel(id) {
		document.getElementById(id).style.display = "block";
	}

	// 隐藏层
	function hidePanel(id) {
		document.getElementById(id).style.display = "none";
	}

	//绑定事件
	function doLogin() {
		var msgName = document.getElementById("msgName");
		var msgPwd = document.getElementById("msgPwd");
		var msgLogin = document.getElementById("msgLogin");

		var txtName = document.getElementById("name");
		var txtPwd = document.getElementById("pwd");
		if (txtName.value == "") {
			msgName.innerHTML = "请输入用户名!";
			txtName.focus();
			return;
		}
		if (txtPwd.value == "") {
			msgPwd.innerHTML = "请输入密码!";
			txtPwd.focus();
			return;
		}
		// 匹配账号密码
		var usersStr = localStorage.getItem("runGameUsers");
		// 遍历本地存储，判断用户名是否存在
		if (usersStr == null) {
			msgLogin.innerHTML = "用户名或密码错误!";
		} else {
			// 获取已有的localUsers
			localUsers = JSON.parse(usersStr);
			for (var i = 0; i < localUsers.length; i++) {
				var user = JSON.parse(localUsers[i]);
				if (user.name == txtName.value && user.pwd == txtPwd.value) {
					loginUser = new RunGameUser(txtName.value, txtPwd.value);
					// 登录成功
					loginSuccess(txtName.value);
				}
			}
			msgLogin.innerHTML = "用户名或密码错误!";
		}
	};

	// 打开注册面板
	function register() {
		hidePanel("loginPanel");
		hidePanel("scorePanel");
		showPanel("registerPanel");
		document.getElementById("rName").focus();
	}

	function doRegister() {
		document.getElementById("msgRName").innerHTML = "";
		document.getElementById("msgRPwd").innerHTML = "";
		// 验证用户名密码
		var userName = document.getElementById("rName");
		var pwd = document.getElementById("rPwd");
		if (userName.value == "") {
			document.getElementById("msgRName").innerHTML = "请输入用户名！";
			userName.focus();
			return;
		}
		if (pwd.value == "") {
			document.getElementById("msgRPwd").innerHTML = "请输入密码！";
			pwd.focus();
			return;
		}
		// 写入本地存储
		var localUsers = new Array();
		var usersStr = localStorage.getItem("runGameUsers");
		// 遍历本地存储，判断用户名是否存在
		if (usersStr == null) {
			var user = new RunGameUser(userName.value, pwd.value);
			localUsers.push(JSON.stringify(user));
		} else {
			// 获取已有的localUsers
			localUsers = JSON.parse(usersStr);
			for (var i = 0; i < localUsers.length; i++) {
				var user = JSON.parse(localUsers[i]);
				if (user.name == userName.value) {
					document.getElementById("msgRName").innerHTML = "用户名已存在！";
					return;
				}
			}
			// 写入用户
			localUsers.push(JSON.stringify(new RunGameUser(userName.value,
					pwd.value)));
		}
		// 转变成对象存储
		localStorage.setItem("runGameUsers", JSON.stringify(localUsers));

		// 自动登录
		loginSuccess(userName.value);
	}

	// 登陆成功
	function loginSuccess(userName) {
		// 设置登录用户
		loginUser = new LoginUser(userName, Date.parse(new Date()));
		// 显示登录用户
		document.getElementById("userName").innerHTML = loginUser.name;
		
		// 写入用户登录情况，有则覆盖
		localStorage.setItem("runGameLoginUser", JSON.stringify(loginUser));

		// 隐藏mark窗口
		hidePanel("mark");
	}

	// 用于演示方便用，清除登录数据
	function clearLoginData() {
		localStorage.removeItem("runGameLoginUser");
	}

	// 用于演示方便用，清除积分数据
	function clearScoringData() {
		localStorage.removeItem("scoring");
	}

	// 显示得分排名
	function toggleScoring() {
		var lk = document.getElementById("lk_scoring");
		if (lk.innerHTML == "显示积分面板") {
			showPanel("scorePanel");
			lk.innerHTML = "收起积分面板";
			// 刷新表格数据
			var table = document.getElementById("scoring_table"), trs = table
					.getElementsByTagName("tr");
			// 清除除了第一行的所有行
			for (var i = trs.length - 1; i > 0; i--) {
				table.deleteRow(i);
			}
			// 获取积分，前五
			var scoringStr = localStorage.getItem("scoring");
			if (scoringStr == null)
				return;
			var scoringArr = JSON.parse(scoringStr);
			for (var i = 0; i < scoringArr.length; i++) {
				var scoring = JSON.parse(scoringArr[i]);
				var playTime = scoring.playTime;
				var name = scoring.name;
				var score = scoring.score;
				var newTr = table.insertRow();
				var td1 = newTr.insertCell();
				td1.innerHTML = (i + 1) + ".";
				var td2 = newTr.insertCell();
				td2.innerHTML = name;
				var td3 = newTr.insertCell();
				td3.innerHTML = score;
				// 构建时间
				var newDate = new Date();
				newDate.setTime(playTime);
				var td4 = newTr.insertCell();
				td4.innerHTML = newDate.toLocaleString();
			}
		} else {
			hidePanel("scorePanel");
			lk.innerHTML = "显示积分面板";
		}
	}
	
	function cancel(){
		hidePanel("registerPanel");
		showPanel("loginPanel");
	}
</script>
<script src="code/chapter/15_game.js"></script>
<script src="code/game_levels.js"></script>
<script src="code/chapter/16_canvas.js"></script>
</head>
<body>
	<script>
		runGame(GAME_LEVELS, CanvasDisplay);
	</script>
	<div id="mark" class="mark">
		<div id="loginPanel" class="loginPanel">
			<table class="t_table">
				<tr>
					<td colspan="2">登录</td>
				</tr>
				<tr>
					<td class="title" width="150px;">用户名：</td>
					<td class="txt"><input id="name" size="20" maxlength="14" />
						<label id="msgName" /></td>
				</tr>
				<tr>
					<td class="title" width="150px;">密码：</td>
					<td class="txt"><input id="pwd" size="20" maxlength="14" /> <label
						id="msgPwd" /></td>
				</tr>
				<tr height="20px">
					<td colspan="2"><label id="msgLogin" /></td>
				</tr>
				<tr>
					<td colspan="2"><input type="button" value="登 录"
						onclick="doLogin();">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" value="注 册"
						onclick="register();"></td>
				</tr>
			</table>
		</div>

		<div id="registerPanel" class="registerPanel">
			<table class="t_table">
				<tr>
					<td colspan="2">注册</td>
				</tr>
				<tr>
					<td class="title" width="150px;">用户名：</td>
					<td class="txt"><input id="rName" size="20" maxlength="14" />
						<label id="msgRName" /></td>
				</tr>
				<tr>
					<td class="title" width="150px;">密码：</td>
					<td class="txt"><input id="rPwd" size="20" maxlength="14" />
						<label id="msgRPwd" /></td>
				</tr>
				<tr>
					<td colspan="2"><input type="button" value="注册并登录"
						onclick="doRegister();">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" value="取 消"
						onclick="cancel();"></td>
				</tr>
			</table>
		</div>
	</div>
	<div
		style="position: absolute; top: 20px; right: 50px; width: 350px; height: 30px;">
		<div style="float: left; margin-right: 20px;">
			当前账号：<font><b><label id="userName">未登录</label></b></font>
		</div>
		<div style="float: left; margin-right: 20px;">
			得分：<font><b><label id="score">0</label></b></font>&nbsp;&nbsp;&nbsp;&nbsp;<a
				id="lk_scoring" href="#" onclick="toggleScoring();" />显示积分面板</a>
		</div>
		<div style="float: right; margin-right: 35px; margin-top: 10px;">
			<input type="button" value="清除登录数据" onclick="clearLoginData();" />&nbsp;&nbsp;<input
				type="button" value="清除积分数据" onclick="clearScoringData();" />
		</div>
	</div>

	<div id="scorePanel"
		style="position: absolute; top: 100px; left: 50%; width: 400px; height: 300px; margin-left: -200px; text-align: center; display: none; background-color:  #F5FBFF;">
		<table id="scoring_table" style="width: 100%;">
			<tr>
				<th width="40px">序号</th>
				<th width="60px">账号</th>
				<th width="50px">得分</th>
				<th>游戏时间</th>
			</tr>
		</table>
	</div>
</body>
